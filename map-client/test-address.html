<!DOCTYPE html>
<html>
<head>
    <title>Address Extraction Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .address-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .coordinates {
            font-family: monospace;
            background: #e9ecef;
            padding: 5px;
            border-radius: 3px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìç Address Extraction Test</h1>
        <p>This page tests the address extraction functionality when using current location.</p>
        
        <div id="status" class="status info">Ready to test address extraction</div>
        
        <button onclick="testCurrentLocation()">Test Current Location Address</button>
        <button onclick="testCachedLocation()">Test Cached Location Address</button>
        <button onclick="testSpecificCoordinates()">Test Specific Coordinates</button>
        
        <div id="addressDisplay" class="address-display" style="display: none;"></div>
        
        <div id="testHistory"></div>
    </div>

    <script src="location-service.js"></script>
    <script>
        let geocoder = null;
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        function updateAddressDisplay(address, coordinates, source) {
            const display = document.getElementById('addressDisplay');
            display.innerHTML = `
                <h3>üìç ${source}</h3>
                <div class="coordinates">Lat: ${coordinates.lat.toFixed(6)}, Lng: ${coordinates.lng.toFixed(6)}</div>
                <strong>Extracted Address:</strong><br>
                <span style="font-size: 1.1em; color: #007bff;">${address}</span>
            `;
            display.style.display = 'block';
        }
        
        function addToHistory(address, coordinates, source) {
            const history = document.getElementById('testHistory');
            const time = new Date().toLocaleTimeString();
            
            const entry = document.createElement('div');
            entry.innerHTML = `
                <strong>${source}</strong> - ${time}<br>
                <div class="coordinates">${coordinates.lat.toFixed(6)}, ${coordinates.lng.toFixed(6)}</div>
                <strong>Address:</strong> ${address}<br>
                <hr>
            `;
            history.insertBefore(entry, history.firstChild);
        }
        
        // Initialize geocoder
        function initGeocoder() {
            if (window.google && window.google.maps) {
                geocoder = new google.maps.Geocoder();
                console.log('Geocoder initialized');
            } else {
                console.error('Google Maps not loaded');
            }
        }
        
        // Get address from coordinates (same function as in map.js)
        async function getAddressFromCoordinates(position) {
            return new Promise((resolve, reject) => {
                console.log('Getting address from coordinates:', position.lat(), position.lng());
                
                if (!geocoder) {
                    console.error('Geocoder not available');
                    reject(new Error('Geocoder not available'));
                    return;
                }
                
                geocoder.geocode({ location: position }, function(results, status) {
                    if (status === 'OK' && results[0]) {
                        const result = results[0];
                        console.log('Reverse geocoding result:', result);
                        
                        // Extract a readable address name
                        let addressName = extractReadableAddress(result);
                        console.log('Extracted address name:', addressName);
                        
                        resolve(addressName);
                    } else {
                        console.error('Reverse geocoding failed:', status);
                        reject(new Error(`Geocoding failed: ${status}`));
                    }
                });
            });
        }
        
        // Extract readable address (same function as in map.js)
        function extractReadableAddress(result) {
            console.log('Extracting readable address from result:', result);
            
            // Try to build a nice, readable address
            let streetNumber = '';
            let route = '';
            let sublocality = '';
            let locality = '';
            let administrativeArea = '';
            
            // Extract address components
            for (let component of result.address_components) {
                if (component.types.includes('street_number')) {
                    streetNumber = component.long_name;
                } else if (component.types.includes('route')) {
                    route = component.long_name;
                } else if (component.types.includes('sublocality') || component.types.includes('sublocality_level_1')) {
                    sublocality = component.long_name;
                } else if (component.types.includes('locality')) {
                    locality = component.long_name;
                } else if (component.types.includes('administrative_area_level_1')) {
                    administrativeArea = component.long_name;
                }
            }
            
            // Build the address in order of preference
            let addressParts = [];
            
            // 1. Street address (number + street)
            if (streetNumber && route) {
                addressParts.push(`${streetNumber} ${route}`);
            } else if (route) {
                addressParts.push(route);
            }
            
            // 2. Neighborhood/Area
            if (sublocality && !addressParts.includes(sublocality)) {
                addressParts.push(sublocality);
            }
            
            // 3. City
            if (locality && !addressParts.includes(locality)) {
                addressParts.push(locality);
            }
            
            // 4. State/Province (only if different from city)
            if (administrativeArea && !addressParts.includes(administrativeArea)) {
                addressParts.push(administrativeArea);
            }
            
            // If we have a good address, use it
            if (addressParts.length > 0) {
                let readableAddress = addressParts.join(', ');
                
                // Truncate if too long
                if (readableAddress.length > 80) {
                    readableAddress = readableAddress.substring(0, 77) + '...';
                }
                
                console.log('Built readable address:', readableAddress);
                return readableAddress;
            }
            
            // Fallback to formatted address
            let fallbackAddress = result.formatted_address;
            
            // Truncate if too long
            if (fallbackAddress.length > 80) {
                fallbackAddress = fallbackAddress.substring(0, 77) + '...';
            }
            
            console.log('Using fallback address:', fallbackAddress);
            return fallbackAddress;
        }
        
        async function testCurrentLocation() {
            updateStatus('Getting current location and extracting address...', 'info');
            
            try {
                // Get current location
                const position = await window.locationService.getLocationWithRetry(3);
                const coordinates = { lat: position.coords.latitude, lng: position.coords.longitude };
                
                // Get address
                const pos = new google.maps.LatLng(coordinates.lat, coordinates.lng);
                const address = await getAddressFromCoordinates(pos);
                
                updateStatus('Address extracted successfully!', 'success');
                updateAddressDisplay(address, coordinates, 'Current Location');
                addToHistory(address, coordinates, 'Current Location');
                
            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        async function testCachedLocation() {
            updateStatus('Testing cached location address...', 'info');
            
            try {
                const cachedPosition = window.locationService.getCachedLocation();
                if (!cachedPosition) {
                    updateStatus('No cached location available. Get current location first.', 'warning');
                    return;
                }
                
                const coordinates = { lat: cachedPosition.coords.latitude, lng: cachedPosition.coords.longitude };
                const pos = new google.maps.LatLng(coordinates.lat, coordinates.lng);
                const address = await getAddressFromCoordinates(pos);
                
                updateStatus('Cached location address extracted!', 'success');
                updateAddressDisplay(address, coordinates, 'Cached Location');
                addToHistory(address, coordinates, 'Cached Location');
                
            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        async function testSpecificCoordinates() {
            updateStatus('Testing specific coordinates (Bangalore)...', 'info');
            
            try {
                // Test with Bangalore coordinates
                const coordinates = { lat: 12.9716, lng: 77.5946 };
                const pos = new google.maps.LatLng(coordinates.lat, coordinates.lng);
                const address = await getAddressFromCoordinates(pos);
                
                updateStatus('Specific coordinates address extracted!', 'success');
                updateAddressDisplay(address, coordinates, 'Bangalore Test');
                addToHistory(address, coordinates, 'Bangalore Test');
                
            } catch (error) {
                updateStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        // Initialize when Google Maps loads
        function initMap() {
            initGeocoder();
            updateStatus('Google Maps loaded. Ready to test address extraction!', 'success');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('Loading Google Maps...', 'info');
        });
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB6-shv9yZ-TePQmbXUTiewlRUIe2Y-AAo&callback=initMap" async defer></script>
</body>
</html> 